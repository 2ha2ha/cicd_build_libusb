#include "QLinkLib.h"

#ifdef AUTO_LOAD_CHIPS
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#include <stlink.h>
#include <common_flash.h>
#include <read_write.h>
#include <usb.h>

// 添加到 chipid.c 的代码
// struct stlink_chipid_params **qGetDevicelist(){return &devicelist;}
struct stlink_chipid_params **qGetDevicelist();

struct stlink_chipid_params devicelist_const[] ={{"unknow"},
{"STM32F303_F328_F334"   , NULL, 0x438, 2 , 0x1ffff7cc, 0x800  , 0x3000  , 0x1fffd800, 0x2000 , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32F1xx_MD"          , NULL, 0x410, 2 , 0x1ffff7e0, 0x400  , 0x5000  , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32L0xxx_Cat_3"      , NULL, 0x417, 9 , 0x1ff8007c, 0x80   , 0x2000  , 0x1ff00000, 0x1000 , 0x1ff80000, 0x20  , 0 , 0x0       , 0x0}  , 
{"STM32G07x_G08x"        , NULL, 0x460, 6 , 0x1fff75e0, 0x800  , 0x9000  , 0x1fff0000, 0x7000 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"STM32G49x_G4Ax"        , NULL, 0x479, 7 , 0x1fff75e0, 0x800  , 0x1c000 , 0x1fff0000, 0x7000 , 0x1ffff800, 0x4   , 3 , 0x0       , 0x0}  , 
{"STM32L41x_L42x"        , NULL, 0x464, 10, 0x1fff75e0, 0x800  , 0xa000  , 0x1fff0000, 0x7000 , 0x1fff7800, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32F04x"             , NULL, 0x445, 2 , 0x1ffff7cc, 0x400  , 0x1800  , 0x1fffec00, 0xc00  , 0x1ffff800, 0x10  , 0 , 0x0       , 0x0}  , 
{"STM32G0Bx_G0Cx"        , NULL, 0x467, 6 , 0x1fff75e0, 0x800  , 0x24000 , 0x1fff0000, 0x7000 , 0x1fff7800, 0x80  , 13, 0x0       , 0x0}  , 
{"STM32F1xx_VL_MD_LD"    , NULL, 0x420, 2 , 0x1ffff7e0, 0x400  , 0x2000  , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32U575_U585"        , NULL, 0x482, 11, 0xbfa07a0 , 0x2000 , 0xc4800 , 0xbf90000 , 0x10000, 0x0       , 0x0   , 3 , 0xbfa0000 , 0x200}, 
{"STM32F1xx_LD"          , NULL, 0x412, 2 , 0x1ffff7e0, 0x400  , 0x2800  , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32F2xx"             , NULL, 0x411, 4 , 0x1fff7a22, 0x20000, 0x20000 , 0x1fff0000, 0x7800 , 0x1fffc000, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32F401xB_xC"        , NULL, 0x423, 4 , 0x1fff7a22, 0x4000 , 0x10000 , 0x1fff0000, 0x7800 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32H74x_H75x"        , NULL, 0x450, 8 , 0x1ff1e880, 0x20000, 0x20000 , 0x1ff00000, 0x20000, 0x52002020, 0x2c  , 3 , 0x0       , 0x0}  , 
{"STM32F37x"             , NULL, 0x432, 2 , 0x1ffff7cc, 0x800  , 0xa000  , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32L1xx_Cat_4"       , NULL, 0x436, 9 , 0x1ff800cc, 0x100  , 0xc000  , 0x1ff00000, 0x1000 , 0x1ff80000, 0x8   , 2 , 0x0       , 0x0}  , 
{"STM32U59x_U5Ax"        , NULL, 0x481, 11, 0xbfa07a0 , 0x2000 , 0x274800, 0xbf90000 , 0x8000 , 0x0       , 0x0   , 3 , 0x0       , 0x0}  , 
{"STM32F09x"             , NULL, 0x442, 2 , 0x1ffff7cc, 0x800  , 0x8000  , 0x1fffd800, 0x2000 , 0x1ffff800, 0x10  , 0 , 0x0       , 0x0}  , 
{"STM32F412"             , NULL, 0x441, 4 , 0x1fff7a22, 0x4000 , 0x40000 , 0x1fff0000, 0x7800 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32F410"             , NULL, 0x458, 4 , 0x1fff7a22, 0x4000 , 0x8000  , 0x1fff0000, 0x7800 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32H72x_H73x"        , NULL, 0x483, 8 , 0x1ff1e880, 0x20000, 0x20000 , 0x1ff00000, 0x20000, 0x52002020, 0x2c  , 2 , 0x0       , 0x0}  , 
{"STM32U073xx_U083xx"    , NULL, 0x489, 1 , 0x1fff6ea0, 0x800  , 0xa000  , 0x1fff0000, 0x1400 , 0x1fff7000, 0x1000, 2 , 0x0       , 0x0}  , 
{"STM32F446"             , NULL, 0x421, 4 , 0x1fff7a22, 0x20000, 0x20000 , 0x1fff0000, 0x7800 , 0x40023c14, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32F03x"             , NULL, 0x444, 2 , 0x1ffff7cc, 0x400  , 0x1000  , 0x1fffec00, 0xc00  , 0x1ffff800, 0x10  , 0 , 0x0       , 0x0}  , 
{"STM32F72x_F73x"        , NULL, 0x452, 5 , 0x1ff07a22, 0x800  , 0x40000 , 0x100000  , 0xedc0 , 0x1fff0000, 0x20  , 2 , 0x0       , 0x0}  , 
{"STM32G03x_G04x"        , NULL, 0x466, 6 , 0x1fff75e0, 0x800  , 0x2000  , 0x1fff0000, 0x2000 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"F1xx_HD"               , NULL, 0x414, 2 , 0x1ffff7e0, 0x800  , 0x10000 , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32F42x_F43x"        , NULL, 0x419, 4 , 0x1fff7a22, 0x4000 , 0x40000 , 0x1fff0000, 0x7800 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32F05x"             , NULL, 0x440, 2 , 0x1ffff7cc, 0x400  , 0x2000  , 0x1fffec00, 0xc00  , 0x1ffff800, 0x10  , 0 , 0x0       , 0x0}  , 
{"STM32L47x_L48x"        , NULL, 0x415, 10, 0x1fff75e0, 0x800  , 0x18000 , 0x1fff0000, 0x7000 , 0x1fff7800, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32F302_F303_F398_HD", NULL, 0x446, 2 , 0x1ffff7cc, 0x800  , 0x10000 , 0x1fffd800, 0x2000 , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32C051xx"           , NULL, 0x44c, 1 , 0x1fff75a0, 0x800  , 0x3000  , 0x1fff0000, 0x1800 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"STM32L4Px_L4Qx"        , NULL, 0x471, 10, 0x1fff75e0, 0x1000 , 0xa0000 , 0x1fff0000, 0x7000 , 0x1ff00000, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32H7Ax_H7Bx"        , NULL, 0x480, 8 , 0x8fff80c , 0x20000, 0x20000 , 0x1ff00000, 0x20000, 0x52002020, 0x2c  , 3 , 0x0       , 0x0}  , 
{"STM32WBx0_WBx5"        , NULL, 0x495, 12, 0x1fff75e0, 0x1000 , 0x40000 , 0x1fff0000, 0x7000 , 0x1fff8000, 0x80  , 2 , 0x0       , 0x0}  , 
{"STM32H5xx"             , NULL, 0x484, 11, 0x8fff80c , 0x2000 , 0xa0000 , 0xbf80000 , 0x8000 , 0x0       , 0x0   , 13, 0x0       , 0x0}  , 
{"STM32F401xD_xE"        , NULL, 0x433, 4 , 0x1fff7a22, 0x4000 , 0x18000 , 0x1fff0000, 0x7800 , 0x40023c14, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32F4x5_F4x7"        , NULL, 0x413, 4 , 0x1fff7a22, 0x4000 , 0x30000 , 0x1fff0000, 0x7800 , 0x40023c14, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32L1xx_Cat_3"       , NULL, 0x427, 9 , 0x1ff800cc, 0x100  , 0x8000  , 0x1ff00000, 0x1000 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32C011xx"           , NULL, 0x443, 1 , 0x1fff75a0, 0x800  , 0x1800  , 0x1fff0000, 0x1800 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"STM32F07x"             , NULL, 0x448, 2 , 0x1ffff7cc, 0x800  , 0x4000  , 0x1fffc800, 0x3000 , 0x1ffff800, 0x10  , 0 , 0x0       , 0x0}  , 
{"STM32_C091xx_C92xx"    , NULL, 0x44d, 1 , 0x1fff75a0, 0x800  , 0x9000  , 0x1fff0000, 0x1800 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"STM32L1xx_Cat_1"       , NULL, 0x416, 9 , 0x1ff8004c, 0x100  , 0x4000  , 0x1ff00000, 0x1000 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32U535_U545"        , NULL, 0x455, 11, 0xbfa07a0 , 0x2000 , 0x44800 , 0xbf90000 , 0x8000 , 0x0       , 0x0   , 3 , 0x0       , 0x0}  , 
{"STM32L0xxx_Cat_5"      , NULL, 0x447, 9 , 0x1ff8007c, 0x80   , 0x5000  , 0x1ff00000, 0x2000 , 0x1ff80000, 0x20  , 13, 0x0       , 0x0}  , 
{"STM32F46x_F47x"        , NULL, 0x434, 4 , 0x1fff7a22, 0x4000 , 0x40000 , 0x1fff0000, 0x7800 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32U5Fx_U5Gx"        , NULL, 0x476, 11, 0xbfa07a0 , 0x2000 , 0x2f4800, 0xbf90000 , 0x8000 , 0x0       , 0x0   , 3 , 0x0       , 0x0}  , 
{"STM32L0xxx_Cat_2"      , NULL, 0x425, 9 , 0x1ff8007c, 0x80   , 0x2000  , 0x1ff00000, 0x1000 , 0x1ff80000, 0x20  , 0 , 0x0       , 0x0}  , 
{"STM32F1xx_VL_HD"       , NULL, 0x428, 2 , 0x1ffff7e0, 0x800  , 0x8000  , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32U031xx"           , NULL, 0x459, 1 , 0x1fff3ea0, 0x800  , 0x3000  , 0x1fff0000, 0x1400 , 0x1fff7000, 0x1000, 2 , 0x0       , 0x0}  , 
{"STM32G05x_G06x"        , NULL, 0x456, 6 , 0x1fff75e0, 0x800  , 0x4800  , 0x1fff0000, 0x7000 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"STM32F1xx_CL"          , NULL, 0x418, 2 , 0x1ffff7e0, 0x800  , 0x10000 , 0x1fffb000, 0x4800 , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32L4Rx"             , NULL, 0x470, 10, 0x1fff75e0, 0x1000 , 0xa0000 , 0x1fff0000, 0x7000 , 0x1ff00000, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32L45x_L46x"        , NULL, 0x462, 10, 0x1fff75e0, 0x800  , 0x20000 , 0x1fff0000, 0x7000 , 0x0       , 0x0   , 2 , 0x1fff7000, 0x400}, 
{"STM32L1xx_Cat_2"       , NULL, 0x429, 9 , 0x1ff8004c, 0x100  , 0x8000  , 0x1ff00000, 0x1000 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"unknown"               , NULL, 0x0  , 0 , 0x0       , 0x0    , 0x0     , 0x0       , 0x0    , 0x0       , 0x0   , 0 , 0x0       , 0x0}  , 
{"STM32F1xx_XLD"         , NULL, 0x430, 3 , 0x1ffff7e0, 0x800  , 0x18000 , 0x1fffe000, 0x1800 , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32F74x_F75x"        , NULL, 0x449, 5 , 0x1ff0f442, 0x800  , 0x50000 , 0x100000  , 0xedc0 , 0x1fff0000, 0x20  , 2 , 0x0       , 0x0}  , 
{"STM32F302_F303_358"    , NULL, 0x422, 2 , 0x1ffff7cc, 0x800  , 0xa000  , 0x1ffff000, 0x800  , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32L5x2xx"           , NULL, 0x472, 11, 0xbfa05e0 , 0x1000 , 0x40000 , 0xbf90000 , 0x8000 , 0x0       , 0x0   , 13, 0x0       , 0x0}  , 
{"STM32L41x_L42x"        , NULL, 0x435, 10, 0x1fff75e0, 0x800  , 0xc000  , 0x1fff0000, 0x7000 , 0x1fff7800, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32G47x_G48x"        , NULL, 0x469, 7 , 0x1fff75e0, 0x800  , 0x20000 , 0x1fff0000, 0x7000 , 0x1ffff800, 0x4   , 3 , 0x0       , 0x0}  , 
{"STM32F411xC_xE"        , NULL, 0x431, 4 , 0x1fff7a22, 0x4000 , 0x20000 , 0x1fff0000, 0x7800 , 0x40023c14, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32L1xx_Cat_5"       , NULL, 0x437, 9 , 0x1ff800cc, 0x100  , 0x14000 , 0x1ff00000, 0x1000 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32L0xxx_Cat_1"      , NULL, 0x457, 9 , 0x1ff8007c, 0x80   , 0x2000  , 0x1ff00000, 0x2000 , 0x1ff80000, 0x20  , 0 , 0x0       , 0x0}  , 
{"STM32F413_F423"        , NULL, 0x463, 4 , 0x1fff7a22, 0x4000 , 0x50000 , 0x1fff0000, 0x7800 , 0x0       , 0x0   , 2 , 0x0       , 0x0}  , 
{"STM32F76x_F77x"        , NULL, 0x451, 5 , 0x1ff0f442, 0x800  , 0x80000 , 0x200000  , 0xedc0 , 0x1fff0000, 0x20  , 3 , 0x0       , 0x0}  , 
{"STM32C031xx"           , NULL, 0x453, 1 , 0x1fff75a0, 0x800  , 0x3000  , 0x1fff0000, 0x1800 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{"STM32G43x_G44x"        , NULL, 0x468, 7 , 0x1fff75e0, 0x800  , 0x8000  , 0x1fff0000, 0x7000 , 0x1ffff800, 0x4   , 2 , 0x0       , 0x0}  , 
{"STM32L496x_L4A6x"      , NULL, 0x461, 10, 0x1fff75e0, 0x800  , 0x50000 , 0x1fff0000, 0x7000 , 0x1fff7800, 0x4   , 2 , 0x1fff7000, 0x400}, 
{"STM32WLEx"             , NULL, 0x497, 12, 0x1fff75e0, 0x800  , 0x10000 , 0x1fff0000, 0x7000 , 0x1fff7800, 0x10  , 3 , 0x0       , 0x0}  , 
{"STM32F301_F302_F318"   , NULL, 0x439, 2 , 0x1ffff7cc, 0x800  , 0xa000  , 0x1fffd800, 0x2000 , 0x1ffff800, 0x10  , 2 , 0x0       , 0x0}  , 
{"STM32C071xx"           , NULL, 0x493, 1 , 0x1fff75a0, 0x800  , 0x6000  , 0x1fff0000, 0x1800 , 0x1fff7800, 0x80  , 0 , 0x0       , 0x0}  , 
{NULL}
};

void qDumpChips(const char* filePath) {
    FILE *file = fopen(filePath, "w+");
    if (file == NULL) {
        return;
    }
    struct stlink_chipid_params *devicelist = *qGetDevicelist();
    fprintf(file, "struct stlink_chipid_params devicelist_const[] ={{\"unknow\"},");
    for (struct stlink_chipid_params *dev = devicelist; dev != NULL; dev = dev->next) {
        fprintf(file, "\n{\"%s\",", dev->dev_type);
        fprintf(file, "\"%s\",", dev->ref_manual_id);
        fprintf(file, "0x%x,", dev->chip_id);
        fprintf(file, "%d,",   dev->flash_type);
        fprintf(file, "0x%x,", dev->flash_size_reg);
        fprintf(file, "0x%x,", dev->flash_pagesize);
        fprintf(file, "0x%x,", dev->sram_size);
        fprintf(file, "0x%x,", dev->bootrom_base);
        fprintf(file, "0x%x,", dev->bootrom_size);
        fprintf(file, "0x%x,", dev->option_base);
        fprintf(file, "0x%x,", dev->option_size);
        fprintf(file, "%d,",   dev->flags);
        fprintf(file, "0x%x,", dev->otp_base);
        fprintf(file, "0x%x},",dev->otp_size);
    }
    fprintf(file, "{NULL}\n};");
    fclose(file);
}

static void stlink_add_devicelist(struct stlink_chipid_params arr[]) {
  int i = 0;
  struct stlink_chipid_params *devicelist = *qGetDevicelist();
  for(i=0; arr[i].dev_type != NULL; i++) {
    struct stlink_chipid_params *ts;
    ts = calloc(1, sizeof(struct stlink_chipid_params));
    if (ts==NULL) { continue; }
    ts->dev_type       = arr[i].dev_type;
    ts->ref_manual_id  = arr[i].ref_manual_id;
    ts->chip_id        = arr[i].chip_id;
    ts->flash_type     = arr[i].flash_type;
    ts->flash_size_reg = arr[i].flash_size_reg;
    ts->flash_pagesize = arr[i].flash_pagesize;
    ts->sram_size      = arr[i].sram_size;
    ts->bootrom_base   = arr[i].bootrom_base;
    ts->bootrom_size   = arr[i].bootrom_size;
    ts->option_base    = arr[i].option_base;
    ts->option_size    = arr[i].option_size;
    ts->flags          = arr[i].flags;
    ts->otp_base       = arr[i].otp_base;
    ts->otp_size       = arr[i].otp_size;
    ts->next           = devicelist;
    devicelist = ts;
  }
}

void qAutoLoadChips() {
    static int isInit = 0;
    if (isInit) {
        return;
    }
    isInit = 1;
    stlink_add_devicelist(devicelist_const);
}

#endif
